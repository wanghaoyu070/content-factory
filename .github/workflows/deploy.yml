name: Deploy to Cloud Server

on:
  push:
    branches: [ main ]  # åªæœ‰æŽ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰è§¦å‘
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add host key
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /var/www/content-factory
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin main
          
          # å®‰è£…ä¾èµ– (å¦‚æžœæœ‰æ–°ä¾èµ–)
          # ä½¿ç”¨ --production é¿å…å®‰è£… devDependenciesï¼ŒåŠ å¿«é€Ÿåº¦
          npm install --production
          
          # æž„å»ºé¡¹ç›®
          npm run build
          
          # é‡å¯åº”ç”¨ (ä½¿ç”¨ --update-env ç¡®ä¿èŽ·å–ä»»ä½•æ–°çš„çŽ¯å¢ƒå˜é‡)
          pm2 restart content-factory --update-env
          
          echo "Deployment successful! ðŸš€"
        EOF
