# 内容工厂 - 用户登录系统 Backlog

> 更新日期：2024-12-13

---

## 任务清单

| ID | 需求点 | 优先级 | 预估工作量 | 依赖 | 验收要点 |
|----|--------|--------|------------|------|----------|
| **阶段一：基础认证（MVP）** |||||
| T-001 | 安装配置 NextAuth.js | P0 | 2h | 无 | 依赖安装成功，配置文件创建 |
| T-002 | 创建 GitHub OAuth App | P0 | 0.5h | 无 | 获取 Client ID 和 Secret |
| T-003 | 创建 users 表 | P0 | 1h | 无 | 表结构正确，可插入数据 |
| T-004 | 创建 invite_codes 表 | P0 | 0.5h | T-003 | 表结构正确，外键关联正确 |
| T-005 | 实现 GitHub OAuth 登录流程 | P0 | 3h | T-001, T-002 | 可跳转 GitHub 授权并回调 |
| T-006 | 实现邀请码验证逻辑 | P0 | 2h | T-004, T-005 | 新用户需输入有效邀请码 |
| T-007 | 实现第一用户自动成为管理员 | P0 | 1h | T-006 | 第一个注册用户 role=admin |
| T-008 | 创建登录页面 `/login` | P0 | 2h | T-005 | 页面可访问，GitHub 登录按钮可用 |
| T-009 | 创建邀请码输入页面 | P0 | 2h | T-006 | 新用户可输入邀请码完成注册 |
| **阶段二：数据隔离** |||||
| T-010 | articles 表添加 user_id 字段 | P0 | 1h | T-003 | 字段添加成功 |
| T-011 | search_records 表添加 user_id 字段 | P0 | 1h | T-003 | 字段添加成功 |
| T-012 | settings 表改造为多用户 | P0 | 2h | T-003 | 支持 user_id + key 复合主键 |
| T-013 | 编写数据迁移脚本 | P0 | 2h | T-010, T-011, T-012 | 现有数据归属第一用户 |
| T-014 | 修改 articles API 添加用户过滤 | P0 | 2h | T-010 | 用户只能查看自己的文章 |
| T-015 | 修改 search API 添加用户过滤 | P0 | 2h | T-011 | 用户只能查看自己的搜索记录 |
| T-016 | 修改 settings API 添加用户过滤 | P0 | 2h | T-012 | 用户只能查看自己的配置 |
| T-017 | 修改 insights API 添加用户过滤 | P0 | 1h | T-015 | 洞察数据按用户隔离 |
| T-018 | 修改 dashboard API 添加用户过滤 | P0 | 1h | T-014, T-015 | 仪表盘数据按用户隔离 |
| **阶段三：访问控制** |||||
| T-019 | 创建认证中间件 | P0 | 2h | T-005 | 可判断用户登录状态 |
| T-020 | API 路由添加认证检查 | P0 | 3h | T-019 | 写操作需要登录 |
| T-021 | 前端添加未登录提示 | P0 | 2h | T-019 | 点击操作按钮提示登录 |
| **阶段四：管理员后台** |||||
| T-022 | 创建 `/admin` 页面 | P1 | 3h | T-007 | 页面可访问 |
| T-023 | 实现管理员权限检查 | P1 | 1h | T-022 | 非管理员无法访问 |
| T-024 | 实现生成邀请码功能 | P1 | 2h | T-022 | 可生成 8 位随机邀请码 |
| T-025 | 实现邀请码列表展示 | P1 | 2h | T-024 | 显示所有邀请码及状态 |
| T-026 | 实现复制邀请码功能 | P1 | 0.5h | T-025 | 一键复制到剪贴板 |
| T-027 | 实现删除邀请码功能 | P1 | 1h | T-025 | 可删除未使用的邀请码 |
| **阶段五：UI 改造** |||||
| T-028 | 移除右上角铃铛图标 | P1 | 0.5h | 无 | 铃铛不再显示 |
| T-029 | 实现右上角用户头像组件 | P1 | 2h | T-005 | 显示头像，点击展开菜单 |
| T-030 | 实现用户下拉菜单 | P1 | 2h | T-029 | 包含个人设置、退出登录 |
| T-031 | 改造左下角用户区域 | P1 | 2h | T-005 | 显示真实用户信息 |
| T-032 | 未登录状态 UI 适配 | P1 | 2h | T-021 | 未登录显示登录按钮 |
| **阶段六：个人设置** |||||
| T-033 | 创建 `/settings/profile` 页面 | P2 | 3h | T-005 | 页面可访问 |
| T-034 | 实现修改昵称功能 | P2 | 1h | T-033 | 昵称可修改并保存 |
| T-035 | 实现修改头像功能 | P2 | 2h | T-033 | 可上传或使用 GitHub 头像 |
| **阶段七：测试与优化** |||||
| T-036 | 编写登录流程测试用例 | P2 | 2h | T-009 | 覆盖正常和异常场景 |
| T-037 | 编写数据隔离测试用例 | P2 | 2h | T-018 | 验证用户间数据隔离 |
| T-038 | 错误处理优化 | P2 | 2h | 全部 | 所有错误有友好提示 |

---

## 优先级说明

| 优先级 | 含义 | 说明 |
|--------|------|------|
| P0 | 必须完成 | 没有这些功能系统无法使用 |
| P1 | 应该完成 | 重要功能，影响用户体验 |
| P2 | 可以完成 | 锦上添花，可后续迭代 |

---

## 里程碑

### MVP（最小可用版本）
- 包含：T-001 ~ T-021
- 目标：用户可以登录、数据隔离、基础访问控制

### v1.0（完整版本）
- 包含：T-022 ~ T-035
- 目标：管理员后台、UI 完善、个人设置

### v1.1（优化版本）
- 包含：T-036 ~ T-038 + 后续优化
- 目标：测试覆盖、体验优化

---

## 依赖关系图

```
T-001 (NextAuth.js)
  └── T-005 (GitHub OAuth)
        ├── T-006 (邀请码验证)
        │     └── T-007 (第一用户管理员)
        │           └── T-022~T-027 (管理员后台)
        ├── T-008 (登录页面)
        ├── T-009 (邀请码页面)
        └── T-019 (认证中间件)
              ├── T-020 (API 认证)
              └── T-021 (前端提示)

T-003 (users 表)
  ├── T-004 (invite_codes 表)
  ├── T-010 (articles.user_id)
  │     └── T-014 (articles API)
  ├── T-011 (search_records.user_id)
  │     └── T-015 (search API)
  │           └── T-017 (insights API)
  └── T-012 (settings 改造)
        └── T-016 (settings API)

T-013 (数据迁移) ← T-010, T-011, T-012
T-018 (dashboard API) ← T-014, T-015
```

---

## 快速开始建议

**第一天：**
1. T-001: 安装 NextAuth.js
2. T-002: 创建 GitHub OAuth App
3. T-003: 创建 users 表
4. T-004: 创建 invite_codes 表

**第二天：**
5. T-005: 实现 GitHub OAuth 登录
6. T-008: 创建登录页面
7. T-006: 实现邀请码验证
8. T-009: 创建邀请码输入页面

**第三天：**
9. T-007: 第一用户管理员
10. T-010 ~ T-012: 数据库改造
11. T-013: 数据迁移

**第四天：**
12. T-014 ~ T-018: API 用户过滤
13. T-019 ~ T-021: 访问控制

**第五天：**
14. T-022 ~ T-027: 管理员后台
15. T-028 ~ T-032: UI 改造
